<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>White Sands Staff System</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background: #000; color: #fff; padding: 10px; text-align: center; margin-bottom: 60px; }
        .card { background: #1a1a1a; padding: 20px; border-radius: 20px; border: 1px solid #333; max-width: 400px; margin: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        #live-clock { font-size: 36px; font-weight: bold; color: #ffcc00; }
        #live-date { font-size: 16px; color: #aaa; margin-bottom: 15px; }
        #user-info { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; background: #252525; padding: 10px; border-radius: 15px; }
        #user-info img { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #ffcc00; background: #333; }
        .loc-status { padding: 18px; margin: 10px 0; border-radius: 15px; font-size: 15px; font-weight: 500; cursor: pointer; border: 2px solid #444; }
        .in-range { background: #28a745; color: white; border: 2px solid #1e7e34; }
        .out-range { background: #dc3545; color: white; border: 2px solid #bd2130; }
        #map-container { width: 100%; height: 180px; border-radius: 15px; margin-top: 10px; overflow: hidden; border: 1px solid #444; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; margin-top: 15px; cursor: pointer; }
        .btn-cam { background: #444; color: white; }
        #save-btn { background: #ffcc00; color: #000; display: none; }
        #permission-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #111; padding: 12px 0; font-size: 10px; border-top: 1px solid #333; display: flex; justify-content: center; gap: 10px; }
        .status-dot { width: 8px; height: 8px; display: inline-block; border-radius: 50%; margin-right: 3px; }
        .dot-green { background: #28a745; box-shadow: 0 0 5px #28a745; }
        .dot-red { background: #dc3545; box-shadow: 0 0 5px #dc3545; }
    </style>
</head>
<body>
    <div class="card">
        <div id="live-clock">00:00:00</div>
        <div id="live-date">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        <div id="user-info">
            <img id="user-img" src="">
            <div style="text-align: left;">
                <div id="user-name">üë§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</div>
                <div id="user-email" style="font-size: 10px; color: #888;">Email: Loading...</div>
            </div>
        </div>
        <div id="loc-info" class="loc-status out-range" onclick="checkLocation()">üìç ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô GPS</div>
        <div id="map-container"><iframe id="google-map" src="" width="100%" height="100%" frameborder="0"></iframe></div>
        <input type="file" id="camera" accept="image/*" capture="user" style="display:none">
        <button class="btn btn-cam" onclick="document.getElementById('camera').click()">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</button>
        <img id="preview" style="width:100%; border-radius:15px; margin-top:15px; display:none; border: 2px solid #ffcc00;">
        <button id="save-btn" class="btn" onclick="submitData()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>

    <div id="permission-bar">
        <span>GPS: <span id="gps-status" class="status-dot dot-red"></span></span>
        <span>LIFF: <span id="liff-status" class="status-dot dot-red"></span></span>
    </div>

    <script>
        const LIFF_ID = "2009020874-nYryKAS5";
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxv1cV-w5yRfEbqZgol-HXIzyLux5wDtkSRtUfRfMd2fey5dw9lFOewxu3y_xl1_vTL1Q/exec";
        const SHOPS = [
            { name: "BLACK BEACH (‡∏ï‡∏•‡∏≤‡∏î‡∏û‡∏•‡∏π)", lat: 13.718257, lng: 100.476981 },
            { name: "BLACK RABBIT (‡∏™‡∏≥‡πÄ‡∏û‡πá‡∏á2)", lat: 13.676830, lng: 100.415685 }
        ];

        let userPos = null, currentShop = null, currentDist = 0;

        setInterval(() => {
            const now = new Date();
            document.getElementById('live-clock').innerText = now.toLocaleTimeString('th-TH', { hour12: false });
            document.getElementById('live-date').innerText = now.toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }, 1000);

        async function initLIFF() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                const idToken = liff.getDecodedIDToken();
                document.getElementById('user-name').innerText = profile.displayName;
                document.getElementById('user-img').src = profile.pictureUrl;
                document.getElementById('user-email').innerText = "Email: " + (idToken.email || "N/A");
                document.getElementById('liff-status').className = "status-dot dot-green";
                checkLocation();
            } catch (e) { console.error(e); }
        }

        function checkLocation() {
            navigator.geolocation.getCurrentPosition(pos => {
                userPos = pos.coords;
                document.getElementById('gps-status').className = "status-dot dot-green";
                const lat = userPos.latitude, lng = userPos.longitude;
                document.getElementById('google-map').src = `https://maps.google.com/maps?q=${lat},${lng}&hl=th&z=16&output=embed`;
                let inRange = false;
                SHOPS.forEach(shop => {
                    const dist = calculateDistance(lat, lng, shop.lat, shop.lng);
                    if (dist <= 100) {
                        inRange = true; currentShop = shop.name; currentDist = dist.toFixed(0);
                        const info = document.getElementById('loc-info');
                        info.innerText = `üìç ${shop.name} (${currentDist} ‡∏°.)`;
                        info.className = "loc-status in-range";
                    }
                });
            }, null, { enableHighAccuracy: true });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180, dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function resizeImage(base64Str) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width, height = img.height;
                    if (width > 600) { height = (600 / width) * height; width = 600; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
            });
        }

        document.getElementById('camera').onchange = function(e) {
            const reader = new FileReader();
            reader.onload = async function(ev) {
                const resized = await resizeImage(ev.target.result);
                const preview = document.getElementById('preview');
                preview.src = resized;
                preview.style.display = "block";
                document.getElementById('save-btn').style.display = "block";
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        async function submitData() {
    const btn = document.getElementById('save-btn');
    btn.disabled = true; 
    btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

    const profile = await liff.getProfile();
    const idToken = liff.getDecodedIDToken();

    const payload = {
        lineId: profile.userId,
        displayName: profile.displayName,
        email: idToken.email || "N/A",
        location: `${userPos.latitude},${userPos.longitude}`,
        shopName: currentShop || "Unknown",
        distance: currentDist,
        imageUrl: document.getElementById('preview').src
    };

    fetch(WEB_APP_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify(payload)
    }).then(() => {
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
        
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° ---
        if (liff.isInClient()) {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
            // liff.closeWindow(); // ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡πÄ‡∏•‡∏¢
            window.location.reload(); // ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        } else {
            window.location.reload(); 
        }
    }).catch(err => {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
        btn.disabled = false;
        btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
    });
}
        window.onload = initLIFF;
    </script>
</body>
</html>

